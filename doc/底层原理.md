# Namespace

借助 `Namespace` 技术实现视图隔离，不同类型的 `Namespace` 可以实现不同资源的隔离

- `PID Namespace`
- `Mount Namespace`
- `UTS Namespace`
- `IPC Namespace`
- `Network Namespace`
- `User Namespace`

本质上只是对视觉显示做了限制，进入对应的 `Namespace` 就可以突破限制
命名空间无法彻底隔离，部分资源无法被命名空间化，修改容器中的对象会导致宿主机也发生改变

```bash
docker run --name debian-1 -d debian tail -f /dev/null
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500                                                                                                                                                                                            
        inet 172.17.0.2  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 06:b7:3a:5e:0d:33  txqueuelen 0  (Ethernet)
        RX packets 4554  bytes 10482736 (9.9 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 2916  bytes 160304 (156.5 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
        
docker inspect -f '{{.State.Pid}}' debian-1
83309
nsenter --target 83309 --net # 进入对应进程的 Namespace
ip a show eth0
eth0@if125: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 06:b7:3a:5e:0d:33 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
```

# Cgroups

限制一个进程组能给使用的资源上限

# 容器镜像 rootfs

一个不包含内核的操作系统，一致性的来源，将整个操作系统打包，因此所有依赖都会被保存
用户制作镜像的每一步操作会生成一个层，这是一个增量 `rootfs`，通过引入层的概念，实现文件系统的复用
镜像层使用了联合文件系统的能力，将多个不同位置的目录联合挂载到同一个目录下，从视图上看上去目录包含多个层的文件

镜像上只包含静态文件，容器是动态的，因此在容器镜像的基础上还需要增加可读层和 `Init` 层
- `Init` 层
  - 以 `-init` 结尾的层，处于只读层和读写层之间
    - 专门存放 `/etc/hosts` 等信息
  - 容器启动时初始化修改的部分数据
- 可读写层
  - 容器中最上面一层，在没有写入文件之前是空的
    - 修改的内容会以增量的方式出现在该层，删除为类似标记的记录
      - `whiteout` 文件表示该文件被上层删除
  - 容器中产生的实时数据
- 只读层
  - 镜像中所有层